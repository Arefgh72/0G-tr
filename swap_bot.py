import os
import time
import random
from web3 import Web3
from eth_hash.auto import keccak

# --- Ø¨Ø®Ø´ Û±: ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ ---
OG_SWAP_AMOUNT = 0.01  # Ù…Ù‚Ø¯Ø§Ø± ØªÙˆÚ©Ù† 0G Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù¾
DEX_ROUTER_ADDRESS = "0x171931f5670037173B9db13ab83186adAb350cF2"
EUCLID_TOKEN_ADDRESS = "0x20329026df239A273F25F4383447342171A40673"

# --- Ø¨Ø®Ø´ Û²: Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ†ÛŒ ---
RPC_URL = "https://evmrpc-testnet.0g.ai"
CHAIN_ID = 16601
EXPLORER_URL_TX_FORMAT = "https://chainscan-galileo.0g.ai/tx/{}"
MINIMAL_ERC20_ABI = '''
[
    {"constant": true, "inputs": [{"name": "_owner", "type": "address"}], "name": "balanceOf", "outputs": [{"name": "balance", "type": "uint256"}], "stateMutability": "view", "type": "function"},
    {"constant": false, "inputs": [{"name": "_spender", "type": "address"},{"name": "_value", "type": "uint256"}], "name": "approve", "outputs": [{"name": "success", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
    {"constant": true, "inputs": [], "name": "decimals", "outputs": [{"name": "", "type": "uint8"}], "stateMutability": "view", "type": "function"}
]
'''
# Ù‚Ø§Ù„Ø¨ Ø¯ÛŒØªØ§ÛŒ Ù‡Ú¯Ø² Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù¾ 0G Ø¨Ù‡ EUCLID (Ø§Ø² ØªØ±Ø§Ú©Ù†Ø´ ÙˆØ§Ù‚Ø¹ÛŒ Ø´Ù…Ø§)
OG_TO_EUCLID_DATA_TEMPLATE = "0x6e31c74900000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000003400000000000000000000000000000000000000000000000000000000000f7a63d000000000000000000000000000000000000000000000000000000000000038000000000000000000000000000000000000000000000000000000000000004a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007a00000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307866646131643631313561343961646637333135373038303064333563393031616434653030353762000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002306700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066575636c6964000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002306700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066575636c696400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019e38f00000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a30786664613164363131356134396164663733313537303830306433356339303161643465303035376200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014b7b2261737365745f696e5f74797065223a226e6174697665222c2272656c6561736573223a5b7b22646578223a226575636c6964222c2272656c656173655f61646472657373223a5b7b22636861696e5f756964223a223067222c2261646472657373223a22307866646131643631313561343961646637333135373038303064333563393031616434653030353762222c22616d6f756e74223a2231363936363535227d5d2c22746f6b656e223a226575636c6964222c22616d6f756e74223a22227d5d2c227377617073223a7b2270617468223a5b7b22726f757465223a5b223067222c226575636c6964225d2c22646578223a226575636c6964222c22636861696e5f756964223a2276736c222c22616d6f756e745f696e223a223130303030303030303030303030303030222c22616d6f756e745f6f7574223a2231363936363535227d5d7d7d000000000000000000000000000000000000000000"
# Ø¯ÛŒØªØ§ÛŒ Ù‡Ú¯Ø² Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù¾ EUCLID Ø¨Ù‡ 0G
EUCLID_TO_OG_DATA_TEMPLATE = "0x6e31c74900000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000019f0a00000000000000000000000000000000000000000000000000000000000000320000000000000000000000000000000000000000000000000002162763adb1670000000000000000000000000000000000000000000000000000000000000036000000000000000000000000000000000000000000000000000000000000004800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007800000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a3078666461316436313135613439616466373331353730383030643335633930316164346530303537620000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000066575636c696400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006000000000000000000000000072975d80179c6a6e1428108f426c8f14eee4622600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002306700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000066575636c69640000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000230670000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002324468ecbabd400000000000000000000000000000000000000000000000000000000000001a0000000000000000000000000000000000000000000000000000000000000022000000000000000000000000000000000000000000000000000000000000002400000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000023067000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a30786664613164363131356134396164663733313537303830306433356339303161643465303035376200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014e7b2261737365745f696e5f74797065223a22736d617274222c2272656c6561736573223a5b7b22646578223a226575636c6964222c2272656c656173655f61646472657373223a5b7b22636861696e5f756964223a223067222c2261646472657373223a22307866646131643631313561343961646637333135373038303064333563393031616434653030353762222c22616d6f756e74223a2239383931353039363436383936303834227d5d2c22746f6b656e223a223067222c22616d6f756e74223a22227d5d2c227377617073223a7b2270617468223a5b7b22726f757465223a5b226575636c6964222c223067225d2c22646578223a226575636c6964222c22636861696e5f756964223a2276736c222c22616d6f756e745f696e223a2231373030303030222c22616d6f756e745f6f7574223a2239383931353039363436383936303834227d5d7d7d000000000000000000000000000000000000"

MINIMAL_ERC20_ABI = '''
[
    {"constant": true, "inputs": [{"name": "_owner", "type": "address"}], "name": "balanceOf", "outputs": [{"name": "balance", "type": "uint256"}], "stateMutability": "view", "type": "function"},
    {"constant": false, "inputs": [{"name": "_spender", "type": "address"},{"name": "_value", "type": "uint256"}], "name": "approve", "outputs": [{"name": "success", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
    {"constant": true, "inputs": [], "name": "decimals", "outputs": [{"name": "", "type": "uint8"}], "stateMutability": "view", "type": "function"}
]
'''

def perform_round_trip_swap():
    print("--- ðŸ¤– Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ø±Ø¨Ø§Øª Ø³ÙˆØ§Ù¾ Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´ØªÛŒ ---")

    # Û±. Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø´Ø¨Ú©Ù‡
    try:
        private_key = os.environ.get('MY_PRIVATE_KEY')
        if not private_key: raise ValueError("Ú©Ù„ÛŒØ¯ Ø®ØµÙˆØµÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        if not private_key.startswith("0x"): private_key = "0x" + private_key

        w3 = Web3(Web3.HTTPProvider(RPC_URL, request_kwargs={'timeout': 120.0}))
        account = w3.eth.account.from_key(private_key)
        
        euclid_token_contract = w3.eth.contract(address=Web3.to_checksum_address(EUCLID_TOKEN_ADDRESS), abi=MINIMAL_ERC20_ABI)
        
        print(f"âœ… Ù…ØªØµÙ„ Ø´Ø¯. Ø¢Ø¯Ø±Ø³: {account.address}")
        print(f" Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§ÙˆÙ„ÛŒÙ‡: {w3.from_wei(w3.eth.get_balance(account.address), 'ether'):.6f} OG")

    except Exception as e:
        print(f"ðŸš¨ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø±Ø­Ù„Ù‡ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ: {e}")
        return

    # Û². Ø³ÙˆØ§Ù¾ Ø§ÙˆÙ„: 0G Ø¨Ù‡ EUCLID
    amount_in_wei = w3.to_wei(OG_SWAP_AMOUNT, 'ether')
    amount_received = 0
    
    print(f"\\n--- Ø´Ø±ÙˆØ¹ Ø³ÙˆØ§Ù¾ Û±: {OG_SWAP_AMOUNT} OG Ø¨Ù‡ EUCLID ---")
    try:
        nonce = w3.eth.get_transaction_count(account.address)
        gas_price = w3.eth.gas_price
        
        # Ø¯Ø± Ø¯ÛŒØªØ§ÛŒ Ø§ØµÙ„ÛŒØŒ Ù…Ù‚Ø¯Ø§Ø± 0.001 Ø§ØªØ± (1000000000000000) Ø¨Ø§ '2386f26fc10000' Ù…Ø´Ø®Øµ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯
        # Ù…Ø§ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø±Ø§ Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        original_amount_in_wei = w3.to_wei(0.001, 'ether')
        dynamic_forward_data = OG_TO_EUCLID_DATA_TEMPLATE.replace(f'{original_amount_in_wei:x}', f'{amount_in_wei:x}')

        tx = {
            'from': account.address,
            'to': Web3.to_checksum_address(DEX_ROUTER_ADDRESS),
            'value': amount_in_wei,
            'gas': 1500000, 
            'gasPrice': gas_price,
            'nonce': nonce,
            'chainId': CHAIN_ID,
            'data': dynamic_forward_data
        }
        
        signed_tx = account.sign_transaction(tx)
        tx_hash = w3.eth.send_raw_transaction(signed_tx.raw_transaction)
        print(f"  ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆØ§Ù¾ Û± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {tx_hash.hex()}")
        
        receipt = w3.eth.wait_for_transaction_receipt(tx_hash, timeout=300)
        if receipt.status != 1: raise Exception(f"ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆØ§Ù¾ Û± Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ (reverted).")
        
        print("  âœ… Ø³ÙˆØ§Ù¾ Û± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.")

        TRANSFER_TOPIC = keccak(text="Transfer(address,address,uint256)").hex()
        for log in receipt['logs']:
            if len(log['topics']) > 2 and log['topics'][0].hex() == TRANSFER_TOPIC and Web3.to_checksum_address('0x' + log['topics'][2].hex()[-40:]) == account.address:
                amount_received = int(log['data'].hex(), 16)
                break
        
        if amount_received <= 0: raise Exception("Ù‡ÛŒÚ† ØªÙˆÚ©Ù† EUCLIDÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù„Ø§Ú¯ Ø¢Ù† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")
        
        token_decimals = euclid_token_contract.functions.decimals().call()
        print(f"  Ù…Ù‚Ø¯Ø§Ø± Ø¯Ù‚ÛŒÙ‚ {amount_received / (10**token_decimals):.6f} EUCLID Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.")

    except Exception as e:
        print(f"ðŸš¨ Ø®Ø·Ø§ Ø¯Ø± Ø³ÙˆØ§Ù¾ Û±: {e}")
        return

    # Û³. Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù…Ø¯Øª Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡
    print("\\n--- Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù‡ Ù…Ø¯Øª Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡... ---")
    time.sleep(600)

    # Û´. Ø³ÙˆØ§Ù¾ Ø¯ÙˆÙ…: EUCLID Ø¨Ù‡ 0G
    print(f"\\n--- Ø´Ø±ÙˆØ¹ Ø³ÙˆØ§Ù¾ Û²: {amount_received / (10**token_decimals):.6f} EUCLID Ø¨Ù‡ OG ---")
    try:
        # Ù…Ø±Ø­Ù„Ù‡ Ø§Ù„Ù: Approve
        nonce = w3.eth.get_transaction_count(account.address)
        gas_price = w3.eth.gas_price
        approve_tx = euclid_token_contract.functions.approve(Web3.to_checksum_address(DEX_ROUTER_ADDRESS), amount_received).build_transaction({
            'from': account.address, 'nonce': nonce, 'gasPrice': gas_price, 'chainId': CHAIN_ID, 'gas': 100000
        })
        signed_approve_tx = account.sign_transaction(approve_tx)
        approve_tx_hash = w3.eth.send_raw_transaction(signed_approve_tx.raw_transaction)
        print(f"  ØªØ±Ø§Ú©Ù†Ø´ Approve Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {approve_tx_hash.hex()}")
        w3.eth.wait_for_transaction_receipt(approve_tx_hash, timeout=300)
        print("  âœ… ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Approve Ø´Ø¯. Û±Û° Ø«Ø§Ù†ÛŒÙ‡ ØªØ§Ø®ÛŒØ±...")
        time.sleep(10)
        
        # Ù…Ø±Ø­Ù„Ù‡ Ø¨: Ø®ÙˆØ¯ Ø³ÙˆØ§Ù¾ Ø¨Ø§ Ø¯ÛŒØªØ§ÛŒ Ø«Ø§Ø¨Øª Ùˆ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ù…Ù‚Ø¯Ø§Ø±
        nonce = w3.eth.get_transaction_count(account.address)
        gas_price = w3.eth.gas_price
        
        placeholder_amount_str = "1700000"
        dynamic_reverse_data = EUCLID_TO_OG_DATA_TEMPLATE.replace(f'"{placeholder_amount_str}"', f'"{amount_received}"')
        
        reverse_tx = {
            'from': account.address,
            'to': Web3.to_checksum_address(DEX_ROUTER_ADDRESS),
            'value': 0,
            'gas': 1300000,
            'gasPrice': gas_price,
            'nonce': nonce,
            'chainId': CHAIN_ID,
            'data': dynamic_reverse_data
        }

        signed_reverse_tx = account.sign_transaction(reverse_tx)
        reverse_tx_hash = w3.eth.send_raw_transaction(signed_reverse_tx.raw_transaction)
        print(f"  ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆØ§Ù¾ Û² Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: {reverse_tx_hash.hex()}")
        receipt_reverse = w3.eth.wait_for_transaction_receipt(reverse_tx_hash, timeout=300)
        if receipt_reverse.status != 1: raise Exception("ØªØ±Ø§Ú©Ù†Ø´ Ø³ÙˆØ§Ù¾ Û² Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ (reverted).")

        print("  âœ… Ø³ÙˆØ§Ù¾ Û² (Ù…Ø¹Ú©ÙˆØ³) Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.")

    except Exception as e:
        print(f"ðŸš¨ Ø®Ø·Ø§ Ø¯Ø± Ø³ÙˆØ§Ù¾ Û²: {e}")
        return
    
    print(f"\\n--- âœ… Ø±ÙˆØªÛŒÙ† Ø³ÙˆØ§Ù¾ Ø±ÙØª Ùˆ Ø¨Ø±Ú¯Ø´ØªÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ú©Ø§Ù…Ù„ Ø´Ø¯. ---")


if __name__ == "__main__":
    perform_round_trip_swap()
